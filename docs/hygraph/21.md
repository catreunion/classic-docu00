---
sidebar_position: 21
---

# Apollo Federation : A modular supergraph architecture

Apollo Federation is an architecture for creating modular graphs. Your graph is built in smaller pieces that all work together.

[FlyBy](https://odyssey-flyby.netlify.app) : Let's imagine we've been transported far into the future, where everyone can traverse the galaxy for fun and adventure. FlyBy's users can browse a list of all the locations fellow space travelers have visited.

## Structure of a supergraph

### One or more separated **subgraphs**

The graph's functionality is divided across smaller, modular graphs called **subgraphs**. --> Schema is split across **multiple schema files**

Each subgraph is a **standalone GraphQL server** with its own schema file, data sources and resolvers. A subgraph schema should contain the types and fields it is responsible for resolving / populating.

How do we connect the fields of a single object when they're resolved by multiple subgraphs? (Lessons 9-14)

In production environment, each server will be managed on its own repository.

```bash title="Servers are split :"
git clone https://github.com/apollographql/odyssey-voyage-I

# each server runs on a different port --> can be run at the same time
# 4000 : router
# 4001 : subgraph-locations
# 4002 : subgraph-reviews

# navigate to subgraph-locations
yarn add @apollo/subgraph
```

### A router (single endpoint)

The router splits incoming GraphQL operations into **smaller operations**, with the help of **supergraph schema**. Each split operation is resolved by a single subgraph.

Supergraph schema is composed of all the fields and types from each subgraph schema. Like a map, it helps the router determine which subgraph can resolve a field in an operation.

A very helpful illustration by [apollographql.com](https://www.apollographql.com/tutorials/voyage-part1/intro-to-federation)

![The journey of a GraphQL operation in a supergraph with the router and subgraphs](https://res.cloudinary.com/apollographql/image/upload/e_sharpen:50,c_scale,q_90,w_1440,fl_progressive/odyssey/federation-course1/F_01_01_IL_04_simple_architecture_exy5jk.png)

## Schema agreement

Collaborate with the frontend team to agree on the app's data requirements and implement a schema-first design. --> Decide how to split up these data needs across multiple subgraphs.

After agreeing on multiple subgraphs, frontend and backend teams can work in parallel. Backend teams can work on their own subgraphs independently, without impacting developers working on other subgraphs, and maintain on their own team.

**Separation of concerns principle** : Clear boundaries of responsibility for different parts of the graph.

Teams have the flexibility to choose the language, infrastructure, and policies that work best for them. Subgraphs can have different numbers of instances, security protocols or caching stragtegies.

## `locations.graphql` : the Homepage

A schema that defines the types and fields owned by the `locations` subgraph.

Contain a selection of the most recently submitted reviews across all locations

Contain a grid of all interplanetary locations.

- Contain overall rating and a snippet of its latest review.

```graphql title="subgraph-locations/locations.graphql"
extend schema @link(url: "https://specs.apollo.dev/federation/v2.0", import: ["@key"])

type Location @key(fields: "id") {
  id: ID!
  name: String!
  description: String!
  photo: String!
}

type Query {
  locations: [Location!]!
  location(id: ID!): Location
}
```

A very helpful illustration by [apollographql.com](https://www.apollographql.com/tutorials/voyage-part1/intro-to-federation)

![An annotated mock-up of the Homepage](https://res.cloudinary.com/apollographql/image/upload/e_sharpen:50,c_scale,q_90,w_1440,fl_progressive/odyssey/federation-course1/F_01_02_MK_21_xwbd1w.png)

```graphql title='Sample query for the Homepage'
query GetHomePageLocationsAndReviews {
  latestReviews {
    id
    comment
    rating
    location {
      name
    }
  }
  locations {
    id
    name
    overallRating
    photo
    reviewsForLocation {
      id
      comment
      rating
    }
  }
}
```

## `reviews.graphql` : the Location page

`overallRating` and `reviewsForLocation` have **more to do with reviews** than they do with locations, even though they happen to be fields on the Location object type.

```graphql title="subgraph-reviews/reviews.graphql"
extend schema @link(url: "https://specs.apollo.dev/federation/v2.0", import: ["@key"])

type Location @key(fields: "id") {
  id: ID!
  overallRating: Float
  "all submitted reviews of a specific location"
  reviewsForLocation: [Review]!
}

type Review {
  id: ID!
  comment: String
  rating: Int
  location: Location
}

input LocationReviewInput {
  comment: String!
  rating: Int!
  locationId: String!
}

type SubmitReviewResponse {
  code: Int!
  success: Boolean!
  message: String!
  locationReview: Review
}

"receive a $locationReview parameter of LocationReviewInput object type"
type Mutation {
  submitReview(locationReview: LocationReviewInput): SubmitReviewResponse
}

type Query {
  "3 latest reviews submitted for FlyBy's locations"
  latestReviews: [Review!]!
}
```

A very helpful illustration by [apollographql.com](https://www.apollographql.com/tutorials/voyage-part1/intro-to-federation)

![An annotated mock-up of the Location page](https://res.cloudinary.com/apollographql/image/upload/e_sharpen:50,c_scale,q_90,w_1440,fl_progressive/odyssey/federation-course1/F_01_02_MK_22_sfwd1g.jpg)

```graphql title='Sample query for the Location page'
query GetLocationDetails($locationId: ID!) {
  location(id: $locationId) {
    id
    name
    description
    photo
    overallRating
    reviewsForLocation {
      id
      comment
      rating
    }
  }
}
```

```graphql title='Sample mutation of submitting a review'
mutation SubmitReview($locationReview: LocationReviewInput) {
  submitReview(locationReview: $locationReview) {
    code
    success
    message
    locationReview {
      id
      comment
      rating
    }
  }
}
```

```
query GetAllLocations {
  locations {
    id
    name
    description
    photo
  }
}

query GetLatestReviews {
  latestReviews {
    id
    comment
    rating
  }
}
```

## wording

intergalactic travels
dip our toes into the world of Federation
put concepts into practice
For a smoother learning experience
don't need to know a thing about how the graph is built under the hood.
locations presented by the Interplanetary Space Tourism department
See how things fit together with the frontend (Lesson 14)
easier to scale
